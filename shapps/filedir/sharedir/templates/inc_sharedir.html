{{use "avalon"}}
{{use "jqcookie"}}
<div ms-controller="sharedir">
<span ms-repeat-el="rpathlist"><a ms-href="#/{%el.rpath%}">{%el.name%}</a> / </span>
<br></br>
<table class="table">
<tr><th>Name</th> <th>Last modified</th> <th>Size</th></tr>
<tr ms-repeat-el="entries"><td><span ms-if="el.isdir"><i ms-class="icon-folder-close"></i>&nbsp<a ms-href="#/{%el.rpath%}">{%el.name%}</a></span><span ms-if="!el.isdir"><i ms-class="icon-file"></i>&nbsp<a ms-href="/sharedir_download/{%dname%}/{%el.rpath%}">{%el.name%}</a></span></td><td>{%el.mtime%}</td><td>{%el.size%}</td></tr>
</table>
</div>
<script>
require(["ready!", 'avalon', "mmRouter"], function() {
    var model = avalon.define("sharedir", function(vm){
        vm.dname = "{{=dname}}"
        vm.cookie_name = "sharedir_"+vm.dname
        vm.rpath = ""
        vm.rpathlist = []
        vm.entries = []
        vm.first_visit = true
        vm.update_rpath_entries = function(rpath) {
            var rpath2 = rpath || vm.rpath
            $.ajax({
              type: "GET",
              url: "/api/sharedir/listdir/"+vm.dname+"?rpath="+rpath2,
              success: function(data){
                var entries = data.entries
                var rpathlist = data.rpathlist
                vm.entries = entries
                vm.rpathlist = rpathlist
                if (!vm.first_visit) {
                    $.cookie(vm.cookie_name,vm.rpath)
                }
                else {
                    vm.first_visit = false
                }
                document.title=vm.dname+"/"+decodeURIComponent(rpath2)
              }
            })
        }
        vm.set_rpath = function(rpath){
            if (vm.first_visit) {
                vm.rpath = rpath || $.cookie(model.cookie_name)
            }
            else {
                vm.rpath = rpath || ""
            }
            vm.update_rpath_entries()
        }
    })
    avalon.router.get("/", function(a) {
        model.set_rpath("",model.first_visit)
    })
    avalon.router.get("/:rpath", function(a) {
        var rpath_param = this.path.substring(1)
        model.set_rpath(rpath_param,model.first_visit)
    })
    avalon.history.start({basepath: "/sharedir/"+model.dname})
    avalon.scan()
})
</script>
